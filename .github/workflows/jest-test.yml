name: Profile API Test Cases

on:
  deployment_status:

jobs:
  run_tests:
    if: github.event.deployment_status.state == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 10.7.1
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Set environment variables
        id: url
        run: |
          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"

          if [ "${{ github.event.deployment.environment }}" == "production" ]; then
            echo "value=https://api-production.web3.bio" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "graphql_server=https://graph.web3.bio/graphql" >> $GITHUB_OUTPUT
          else
            echo "value=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "graphql_server=https://graph-staging.web3.bio/graphql" >> $GITHUB_OUTPUT
          fi

      - name: Print test environment
        run: |
          echo "=========================================="
          echo "BASE_URL: ${{ steps.url.outputs.value }}"
          echo "ENVIRONMENT: ${{ steps.url.outputs.environment }}"
          echo "GRAPHQL_SERVER: ${{ steps.url.outputs.graphql_server }}"
          echo "=========================================="

      - run: pnpm test
        env:
          BASE_URL: ${{ steps.url.outputs.value }}
          ENVIRONMENT: ${{ steps.url.outputs.environment }}
          GRAPHQL_SERVER: ${{ steps.url.outputs.graphql_server }}
          GENERAL_IDENTITY_GRAPH_API_KEY: ${{ secrets.GENERAL_IDENTITY_GRAPH_API_KEY }}
